<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Event Lingkungan - Trash To Cash</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #2E7D32;
      --primary-light: #4CAF50;
      --primary-dark: #1B5E20;
      --text-on-primary: #FFFFFF;
      --background: #F5F9F5;
      --card-bg: #FFFFFF;
      --text-color: #333333;
      --text-secondary: #666666;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', 'Poppins', sans-serif;
      background-color: var(--background);
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }
    
    .container {
      max-width: 100%;
      padding: 0 15px;
    }
    
    header {
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }
    
    .header-icon {
      margin-right: 10px;
    }
    
    .loading {
      text-align: center;
      padding: 30px;
      font-size: 1.2rem;
      color: var(--text-secondary);
    }
    
    .event-list {
      padding: 15px 0;
    }
    
    .event-card {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .event-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    
    .event-card img {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid rgba(0,0,0,0.1);
    }
    
    .event-card h2 {
      color: var(--primary-dark);
      font-size: 1.3rem;
      margin-bottom: 10px;
    }
    
    .event-card p {
      margin-bottom: 8px;
      color: var(--text-color);
    }
    
    .event-card .event-meta {
      display: flex;
      align-items: center;
      margin: 10px 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .event-card .event-meta i {
      margin-right: 8px;
      color: var(--primary-color);
      width: 20px;
      text-align: center;
    }
    
    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    
    .route-button, .whatsapp-button {
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      font-size: 0.9rem;
    }
    
    .route-button {
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      border: none;
      flex-grow: 1;
      margin-right: 10px;
    }
    
    .route-button:hover {
      background-color: var(--primary-dark);
    }
    
    .whatsapp-button {
      background-color: #25D366;
      color: white;
      border: none;
    }
    
    .whatsapp-button:hover {
      background-color: #128C7E;
    }
    
    .button-icon {
      margin-right: 8px;
    }
    
    #map {
      height: 300px;
      width: 100%;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.1);
    }
    
    .location-permission {
      background-color: #FFF3E0;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      display: flex;
      align-items: center;
    }
    
    .location-permission i {
      color: #FB8C00;
      font-size: 1.5rem;
      margin-right: 10px;
    }
    
    .location-permission p {
      flex: 1;
      font-size: 0.9rem;
    }
    
    .location-permission button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    
    @media (min-width: 768px) {
      .container {
        max-width: 750px;
        margin: 0 auto;
      }
      
      #map {
        height: 400px;
      }
      
      .event-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
      }
      
      .event-card {
        margin-bottom: 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1><i class="fas fa-leaf header-icon"></i>Event Lingkungan</h1>
    </div>
  </header>

  <main class="container">
    <div id="location-permission" class="location-permission" style="display: none;">
      <i class="fas fa-info-circle"></i>
      <p>Izinkan akses lokasi untuk melihat rute terbaik ke lokasi event.</p>
      <button id="enable-location">Aktifkan Lokasi</button>
    </div>

    <div id="event-list" class="event-list">
      <div class="loading">
        <i class="fas fa-spinner fa-spin"></i> Memuat event...
      </div>
    </div>

    <div id="map"></div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script>
    const sheetID = '1ZUhP4_Vzg4xixgQpprDIsyBLG-4a-Xn5uDSqORAFRPQ';
    const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

    let userLat = -7.7873;
    let userLng = 113.3763;
    let userLocationAllowed = false;
    let map;
    let userMarker;

    // Elements
    const locationPermissionEl = document.getElementById('location-permission');
    const enableLocationBtn = document.getElementById('enable-location');
    const eventListEl = document.getElementById('event-list');

    // Check geolocation support and permissions
    function checkLocationPermission() {
      if (!navigator.geolocation) {
        locationPermissionEl.querySelector('p').textContent = 'Browser Anda tidak mendukung geolokasi.';
        return;
      }

      navigator.permissions.query({name: 'geolocation'}).then(permissionStatus => {
        if (permissionStatus.state === 'granted') {
          getUserLocation();
        } else if (permissionStatus.state === 'prompt') {
          locationPermissionEl.style.display = 'flex';
        } else {
          locationPermissionEl.querySelector('p').textContent = 'Anda telah memblokir akses lokasi. Aktifkan di pengaturan browser untuk melihat rute.';
          locationPermissionEl.style.display = 'flex';
        }
      });
    }

    // Get user location
    function getUserLocation() {
      navigator.geolocation.getCurrentPosition(
        pos => {
          userLat = pos.coords.latitude;
          userLng = pos.coords.longitude;
          userLocationAllowed = true;
          locationPermissionEl.style.display = 'none';
          
          // Update map view
          if (map) {
            map.setView([userLat, userLng], 13);
          }
          
          // Update user marker
          if (userMarker) {
            userMarker.setLatLng([userLat, userLng]);
          } else if (map) {
            userMarker = L.marker([userLat, userLng], {
              icon: L.divIcon({
                html: '<i class="fas fa-map-marker-alt" style="color: #2E7D32; font-size: 32px;"></i>',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                className: 'user-location-icon'
              })
            }).addTo(map).bindPopup('Lokasi Anda');
          }
        },
        error => {
          console.error('Error getting location:', error);
          locationPermissionEl.querySelector('p').textContent = 'Tidak dapat mendapatkan lokasi Anda. Pastikan GPS aktif atau izinkan akses lokasi.';
          locationPermissionEl.style.display = 'flex';
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    // Initialize map
    function initMap() {
      map = L.map('map').setView([userLat, userLng], 13);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Add user marker if location is available
      if (userLocationAllowed) {
        userMarker = L.marker([userLat, userLng], {
          icon: L.divIcon({
            html: '<i class="fas fa-map-marker-alt" style="color: #2E7D32; font-size: 32px;"></i>',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            className: 'user-location-icon'
          })
        }).addTo(map).bindPopup('Lokasi Anda');
      }
    }

    // Load events from Google Sheets
    function loadEvents() {
      fetch(sheetURL)
        .then(response => response.text())
        .then(text => {
          try {
            const json = JSON.parse(text.substring(47).slice(0, -2));
            const rows = json.table.rows;
            
            if (rows.length === 0) {
              eventListEl.innerHTML = '<div class="loading">Tidak ada event yang tersedia saat ini.</div>';
              return;
            }
            
            eventListEl.innerHTML = '';
            
            rows.forEach(row => {
              const [
                nama, deskripsi, tanggal, waktu,
                penyelenggara, kontakWA, posterURL, lat, lng
              ] = row.c.map(cell => cell ? cell.v : '');
              
              if (!nama) return;
              
              // Create event card
              const card = document.createElement('div');
              card.className = 'event-card';
              card.innerHTML = `
                <img src="${posterURL || 'https://via.placeholder.com/600x300?text=Event+Poster'}" alt="Poster ${nama}" />
                <h2>${nama}</h2>
                <p>${deskripsi || 'Deskripsi tidak tersedia'}</p>
                
                <div class="event-meta">
                  <i class="far fa-calendar-alt"></i>
                  <span>${tanggal || 'Tanggal belum ditentukan'} ${waktu || ''}</span>
                </div>
                
                <div class="event-meta">
                  <i class="fas fa-user-tie"></i>
                  <span>${penyelenggara || 'Penyelenggara tidak diketahui'}</span>
                </div>
                
                <div class="action-buttons">
                  <button class="route-button" data-lat="${lat}" data-lng="${lng}">
                    <i class="fas fa-route button-icon"></i> Lihat Rute
                  </button>
                  <a href="https://wa.me/${kontakWA}" class="whatsapp-button" target="_blank">
                    <i class="fab fa-whatsapp button-icon"></i> Hubungi
                  </a>
                </div>
              `;
              
              eventListEl.appendChild(card);
              
              // Add event marker to map
              if (lat && lng) {
                const eventMarker = L.marker([parseFloat(lat), parseFloat(lng)], {
                  icon: L.divIcon({
                    html: '<i class="fas fa-recycle" style="color: #FFFFFF; font-size: 20px; background: #2E7D32; padding: 8px; border-radius: 50%;"></i>',
                    iconSize: [36, 36],
                    iconAnchor: [18, 36],
                    className: 'event-marker-icon'
                  })
                }).addTo(map);
                
                eventMarker.bindPopup(`
                  <h3 style="margin: 0 0 5px 0; color: var(--primary-color);">${nama}</h3>
                  <p style="margin: 0 0 3px 0;"><i class="far fa-calendar-alt" style="color: var(--primary-color);"></i> ${tanggal} ${waktu}</p>
                  <a href="https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${lat},${lng}" 
                     target="_blank" 
                     style="display: inline-block; background: var(--primary-color); color: white; padding: 5px 10px; border-radius: 4px; text-decoration: none; margin-top: 5px;">
                    <i class="fas fa-route"></i> Rute
                  </a>
                `);
              }
            });
            
            // Add event listeners to route buttons
            document.querySelectorAll('.route-button').forEach(button => {
              button.addEventListener('click', function() {
                const destLat = this.getAttribute('data-lat');
                const destLng = this.getAttribute('data-lng');
                
                if (!destLat || !destLng) {
                  alert('Lokasi event tidak valid');
                  return;
                }
                
                if (!userLocationAllowed) {
                  alert('Aktifkan lokasi Anda untuk melihat rute');
                  locationPermissionEl.style.display = 'flex';
                  return;
                }
                
                window.open(`https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${destLat},${destLng}&travelmode=driving`, '_blank');
              });
            });
            
          } catch (error) {
            console.error('Error parsing events:', error);
            eventListEl.innerHTML = '<div class="loading">Gagal memuat event. Silakan coba lagi nanti.</div>';
          }
        })
        .catch(error => {
          console.error('Error loading events:', error);
          eventListEl.innerHTML = '<div class="loading">Gagal memuat event. Silakan coba lagi nanti.</div>';
        });
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      initMap();
      checkLocationPermission();
      loadEvents();
      
      // Enable location button handler
      enableLocationBtn.addEventListener('click', getUserLocation);
    });
  </script>
</body>
</html>